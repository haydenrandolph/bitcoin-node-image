name: Build Bitcoin Node Raspberry Pi Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Test script syntax
      run: |
        chmod +x scripts/test-syntax.sh
        bash scripts/test-syntax.sh

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static binfmt-support kpartx xz-utils curl git parted

    - name: Download Raspberry Pi OS Lite
      run: |
        curl -L -o raspios.img.xz https://downloads.raspberrypi.org/raspios_lite_arm64_latest
        unxz raspios.img.xz
        mv *.img raspi-custom.img

    - name: Mount and Customize OS Image
      run: |
        chmod +x scripts/customize-image.sh scripts/bootstrap-rpc-creds.sh
        sudo scripts/customize-image.sh raspi-custom.img scripts/bootstrap-rpc-creds.sh
      timeout-minutes: 60

    - name: Compress image
      run: |
        xz -T0 raspi-custom.img

    - name: Upload customized image
      uses: actions/upload-artifact@v4
      with:
        name: raspberry-pi-bitcoin-node
        path: raspi-custom.img.xz