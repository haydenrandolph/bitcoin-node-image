name: Build Bitcoin Node Raspberry Pi Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  GCP_BUCKET: bitcoin-node-artifact-store

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Test script syntax
      run: |
        chmod +x scripts/test-syntax.sh
        bash scripts/test-syntax.sh

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static binfmt-support kpartx xz-utils curl git parted

    - name: Download Raspberry Pi OS Lite
      run: |
        curl -L -o raspios.img.xz https://downloads.raspberrypi.org/raspios_lite_arm64_latest
        unxz raspios.img.xz
        mv *.img raspi-custom.img

    - name: Mount and Customize OS Image
      run: |
        chmod +x scripts/customize-image.sh scripts/bootstrap-rpc-creds.sh
        sudo scripts/customize-image.sh raspi-custom.img scripts/bootstrap-rpc-creds.sh
      timeout-minutes: 120

    - name: Compress image
      run: |
        xz -T0 raspi-custom.img

    - name: Setup GCP credentials
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Install gcloud CLI
      uses: google-github-actions/setup-gcloud@v2

    - name: Upload to GCP Storage
      run: |
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        FILENAME="raspberry-pi-bitcoin-node_${TIMESTAMP}.img.xz"
        mv raspi-custom.img.xz "$FILENAME"
        
        echo "Uploading $FILENAME to gs://$GCP_BUCKET/"
        gsutil cp "$FILENAME" "gs://$GCP_BUCKET/"
        
        # Create a latest symlink
        gsutil cp "gs://$GCP_BUCKET/$FILENAME" "gs://$GCP_BUCKET/raspberry-pi-bitcoin-node_latest.img.xz"
        
        echo "âœ… Image uploaded successfully!"
        echo "ðŸ“ File: gs://$GCP_BUCKET/$FILENAME"
        echo "ðŸ”— Latest: gs://$GCP_BUCKET/raspberry-pi-bitcoin-node_latest.img.xz"
        
        # Output the download URL for easy access
        echo "DOWNLOAD_URL=https://storage.googleapis.com/$GCP_BUCKET/$FILENAME" >> $GITHUB_ENV
        echo "LATEST_URL=https://storage.googleapis.com/$GCP_BUCKET/raspberry-pi-bitcoin-node_latest.img.xz" >> $GITHUB_ENV

    - name: Display download links
      run: |
        echo "ðŸŽ‰ Build completed successfully!"
        echo ""
        echo "ðŸ“¥ Download links:"
        echo "   Latest version: $LATEST_URL"
        echo "   This build: $DOWNLOAD_URL"
        echo ""
        echo "ðŸ’¡ To download:"
        echo "   curl -L '$LATEST_URL' -o raspberry-pi-bitcoin-node.img.xz"
        echo "   xz -d raspberry-pi-bitcoin-node.img.xz"